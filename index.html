<!DOCTYPE html>
<html lang="zh-TW" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PTT 留言分析器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* 基本樣式 */
      body {
        font-family: "Inter", "Noto Sans TC", sans-serif;
      }
      /* Tooltip 樣式 */
      .tooltip {
        position: relative;
        display: inline-block;
      }
      .tooltip .tooltip-text {
        visibility: hidden;
        width: 320px;
        background-color: #2d3748;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        bottom: 150%;
        left: 50%;
        margin-left: -160px;
        opacity: 0;
        transition: opacity 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        pointer-events: none;
      }
      /* (版型修正) 調整彈出位置 */
      .tooltip .tooltip-text {
        bottom: auto;
        top: 150%;
      }
      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-300">
    <main class="container mx-auto p-4 md:p-8 max-w-4xl">
      <!-- 標題 -->
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-white">PTT 留言分析器</h1>
        <div class="tooltip">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-gray-400 hover:text-white cursor-pointer"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          <div class="tooltip-text">
            <h3 class="font-bold text-lg mb-2 text-green-400">使用說明</h3>
            <ul class="list-disc list-inside space-y-2 text-sm">
              <!-- (需求修改) 調整說明順序 -->
              <li>
                <strong>高亮條件</strong>:
                <p class="pl-2">
                  根據特定看板的留言數或佔比，將符合條件的使用者標示出來。格式為
                  <span class="text-green-400 font-mono"
                    >看板名稱,比較符,數字</span
                  >。
                </p>
                <p class="pl-2">
                  比較符可以是
                  <span class="text-green-400 font-mono">&gt;</span>,
                  <span class="text-green-400 font-mono">&gt;=</span>,
                  <!-- (HTML 修正) 轉義特殊字元 -->
                  <span class="text-green-400 font-mono">&lt;</span>,
                  <span class="text-green-400 font-mono">&lt;=</span>,
                  <span class="text-green-400 font-mono">==</span>。
                </p>
                <p class="pl-2">
                  數字可帶
                  <span class="text-green-400 font-mono">%</span>
                  代表佔比。例如：<span class="text-green-400 font-mono"
                    >Gossiping,&gt;,10%</span
                  >
                  或
                  <span class="text-green-400 font-mono">Stock,&lt;=,5</span>。
                </p>
              </li>
              <li>
                <strong>留言關鍵字</strong>:
                <p class="pl-2">
                  篩選出留言內容包含特定字詞的使用者。可使用逗號
                  <span class="text-green-400 font-mono">,</span>
                  分隔多個關鍵字，符合任一即可 (OR 邏輯)。
                </p>
              </li>
              <li>
                <strong>留言類型</strong>:
                <p class="pl-2">
                  可複選「推」、「噓」或「→」，篩選出特定類型的留言。
                </p>
              </li>
            </ul>
          </div>
        </div>
      </header>

      <!-- 輸入表單 -->
      <form id="analysis-form" class="space-y-6">
        <!-- 第一排: 文章網址 -->
        <div>
          <label for="url" class="block mb-2 text-lg font-medium text-white"
            >文章網址</label
          >
          <input
            type="url"
            id="url"
            class="w-full bg-gray-800 border border-gray-600 text-white text-base rounded-lg focus:ring-green-500 focus:border-green-500 block p-3"
            placeholder="https://www.ptt.cc/bbs/..."
            required
          />
        </div>

        <!-- 第二排: 高亮條件 -->
        <div>
          <label
            for="highlight"
            class="block mb-2 text-base font-medium text-white"
            >高亮條件 (選填)</label
          >
          <input
            type="text"
            id="highlight"
            class="w-full bg-gray-800 border border-gray-600 text-white text-base rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5"
            placeholder="看板名稱,比較符,數字(%)"
          />
        </div>

        <!-- 第三排: 關鍵字、類型、按鈕 -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 items-end">
          <!-- 留言關鍵字 -->
          <div class="sm:col-span-1">
            <label
              for="keywords"
              class="block mb-2 text-base font-medium text-white"
              >留言關鍵字 (選填)</label
            >
            <input
              type="text"
              id="keywords"
              class="w-full bg-gray-800 border border-gray-600 text-white text-base rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5"
              placeholder="台灣,中國 (以 , 分隔)"
            />
          </div>

          <!-- 留言類型 -->
          <div class="sm:col-span-1">
            <label class="block mb-2 text-base font-medium text-white"
              >留言類型</label
            >
            <div
              class="flex items-center space-x-4 bg-gray-800 border border-gray-600 rounded-lg p-2.5"
            >
              <div class="flex items-center">
                <input
                  id="type-push"
                  type="checkbox"
                  value="push"
                  class="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-600 ring-offset-gray-800 focus:ring-2"
                  checked
                />
                <label
                  for="type-push"
                  class="ml-2 text-sm font-medium text-gray-300"
                  >推</label
                >
              </div>
              <div class="flex items-center">
                <input
                  id="type-hate"
                  type="checkbox"
                  value="hate"
                  class="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-600 ring-offset-gray-800 focus:ring-2"
                  checked
                />
                <label
                  for="type-hate"
                  class="ml-2 text-sm font-medium text-gray-300"
                  >噓</label
                >
              </div>
              <div class="flex items-center">
                <input
                  id="type-arrow"
                  type="checkbox"
                  value="arrow"
                  class="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-600 ring-offset-gray-800 focus:ring-2"
                  checked
                />
                <label
                  for="type-arrow"
                  class="ml-2 text-sm font-medium text-gray-300"
                  >→</label
                >
              </div>
            </div>
          </div>

          <!-- 開始分析按鈕 -->
          <div class="sm:col-span-1">
            <button
              type="submit"
              id="submit-btn"
              class="w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-800 font-medium rounded-lg text-base px-5 py-2.5 text-center transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed flex items-center justify-center"
            >
              <span id="btn-text">開始分析</span>
              <svg
                id="btn-loader"
                class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </form>

      <!-- 進度回報區 -->
      <div id="progress-container" class="hidden mt-6">
        <div class="flex justify-between mb-1">
          <span
            id="progress-text"
            class="text-base font-medium text-white"
          ></span>
          <span id="progress-percentage" class="text-sm font-medium text-white"
            >0%</span
          >
        </div>
        <div class="w-full bg-gray-700 rounded-full h-2.5">
          <div
            id="progress-bar"
            class="bg-green-600 h-2.5 rounded-full"
            style="width: 0%"
          ></div>
        </div>
      </div>

      <!-- 錯誤訊息區 -->
      <div
        id="error-container"
        class="hidden mt-6 p-4 text-sm text-red-400 bg-red-900/20 rounded-lg"
        role="alert"
      ></div>

      <!-- 結果展示區 -->
      <div id="result-container" class="hidden mt-8">
        <div class="flex justify-end mb-4">
          <button
            id="copy-btn"
            class="text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-gray-700 font-medium rounded-lg text-sm px-4 py-2 transition-colors flex items-center"
          >
            <svg
              class="w-4 h-4 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
              ></path>
            </svg>
            <span id="copy-btn-text">複製報告</span>
          </button>
        </div>
        <div
          id="result-tables"
          class="max-h-[60vh] overflow-y-auto rounded-lg border border-gray-700"
        >
          <!-- 表格會動態插入此處 -->
        </div>
      </div>
    </main>

    <script type="module">
      // (修正) 改用符合 Tauri v2 的 ES Module Imports 方式
      import { core, event } from "@tauri-apps/api"
      import { writeText, readText } from "@tauri-apps/plugin-clipboard-manager"

      const { invoke } = core
      const { listen } = event

      // (Debug) 檢查 Tauri API 是否成功載入
      console.log("Tauri API modules imported successfully.")

      // DOM Elements
      const form = document.getElementById("analysis-form")
      const submitBtn = document.getElementById("submit-btn")
      const btnText = document.getElementById("btn-text")
      const btnLoader = document.getElementById("btn-loader")
      const progressContainer = document.getElementById("progress-container")
      const progressText = document.getElementById("progress-text")
      const progressBar = document.getElementById("progress-bar")
      const progressPercentage = document.getElementById("progress-percentage")
      const errorContainer = document.getElementById("error-container")
      const resultContainer = document.getElementById("result-container")
      const resultTables = document.getElementById("result-tables")
      const copyBtn = document.getElementById("copy-btn")
      const copyBtnText = document.getElementById("copy-btn-text")

      // App state
      let analysisResultCache = null

      // Event Listeners
      console.log("Setting up event listeners...")
      listen("SCRAPE_PROGRESS", (event) => {
        const { current, total, user_id } = event.payload
        const percentage = Math.round((current / total) * 100)
        progressText.textContent = `[${current}/${total}] 正在查詢 ${user_id}...`
        progressBar.style.width = `${percentage}%`
        progressPercentage.textContent = `${percentage}%`
      })

      form.addEventListener("submit", async (e) => {
        e.preventDefault()
        // (Debug) 確認 submit 事件已觸發
        console.log("Form submitted. Analysis started.")

        setLoadingState(true)
        resetUI()

        const url = document.getElementById("url").value
        const keywords = document
          .getElementById("keywords")
          .value.split(",")
          .map((k) => k.trim())
          .filter((k) => k)
        const highlightCondition = document.getElementById("highlight").value

        const filterTypes = []
        document
          .querySelectorAll('input[type="checkbox"]:checked')
          .forEach((checkbox) => {
            filterTypes.push(checkbox.value)
          })

        const payload = {
          url,
          filterTypes,
          keywords: keywords.length > 0 ? keywords : null,
          highlightCondition: highlightCondition || null,
        }

        // (Debug) 顯示即將傳送給後端的 payload
        console.log("Invoking 'analyze_ptt_article' with payload:", payload)

        try {
          const result = await invoke("analyze_ptt_article", payload)
          // (Debug) 顯示後端成功回傳的結果
          console.log("Backend returned result:", result)
          analysisResultCache = result // Cache result for copy functionality
          renderResult(result)
        } catch (error) {
          // (Debug) 顯示後端回傳的錯誤
          console.error("Backend returned an error:", error)
          showError(error)
        } finally {
          setLoadingState(false)
          // (Debug) 確認分析流程結束 (無論成功或失敗)
          console.log("Analysis finished.")
        }
      })

      copyBtn.addEventListener("click", async () => {
        if (!analysisResultCache) return

        const reportText = generateReportText(analysisResultCache)
        try {
          await writeText(reportText)
          copyBtnText.textContent = "已複製 ✓"
          setTimeout(() => {
            copyBtnText.textContent = "複製報告"
          }, 2000)
        } catch (err) {
          console.error("無法複製到剪貼簿:", err)
          copyBtnText.textContent = "複製失敗"
        }
      })
      console.log("Event listeners set up.")

      // UI Functions
      function setLoadingState(isLoading) {
        submitBtn.disabled = isLoading
        btnText.classList.toggle("hidden", isLoading)
        btnLoader.classList.toggle("hidden", !isLoading)
      }

      function resetUI() {
        errorContainer.classList.add("hidden")
        resultContainer.classList.add("hidden")
        progressContainer.classList.remove("hidden")
        progressBar.style.width = "0%"
        progressText.textContent = "準備開始分析..."
        progressPercentage.textContent = "0%"
        resultTables.innerHTML = ""
        analysisResultCache = null
      }

      function renderResult(result) {
        progressContainer.classList.add("hidden")
        resultContainer.classList.remove("hidden")
        resultTables.innerHTML = "" // Clear previous results

        if (
          result.highlighted_data.length === 0 &&
          result.normal_data.length === 0
        ) {
          resultTables.innerHTML = `<p class="p-4 text-center text-gray-400">找不到符合條件的使用者留言。</p>`
          return
        }

        if (result.highlighted_data.length > 0) {
          resultTables.appendChild(
            createTable(result.highlighted_data, "高亮使用者")
          )
        }
        if (result.normal_data.length > 0) {
          resultTables.appendChild(
            createTable(result.normal_data, "一般使用者")
          )
        }
      }

      function createTable(data, title) {
        const allBoards = new Set()
        data.forEach((user) => {
          Object.keys(user.board_comments).forEach((board) =>
            allBoards.add(board)
          )
        })
        const sortedBoards = Array.from(allBoards).sort()
        const headers = [
          "使用者",
          "本文留言數",
          ...sortedBoards,
          "生涯總留言數",
        ]

        const container = document.createElement("div")
        container.innerHTML = `
          <h3 class="text-xl font-semibold p-4 bg-gray-800 text-white sticky top-0 z-10">${title}</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-400">
              <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                <tr>
                  ${headers
                    .map((h) => `<th scope="col" class="px-6 py-3">${h}</th>`)
                    .join("")}
                </tr>
              </thead>
              <tbody>
                ${data
                  .map(
                    (user) => `
                  <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-600">
                    <td class="px-6 py-4 font-medium text-white whitespace-nowrap">${
                      user.user
                    }</td>
                    <td class="px-6 py-4">${user.article_comments}</td>
                    ${sortedBoards
                      .map(
                        (board) =>
                          `<td class="px-6 py-4">${
                            user.board_comments[board] || 0
                          }</td>`
                      )
                      .join("")}
                    <td class="px-6 py-4">${user.total_comments}</td>
                  </tr>
                `
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `
        return container
      }

      function showError(error) {
        progressContainer.classList.add("hidden")
        errorContainer.textContent = `發生錯誤: ${error}`
        errorContainer.classList.remove("hidden")
      }

      function generateReportText(result) {
        let text = ""
        const generateTableText = (data, title) => {
          if (data.length === 0) return ""
          const allBoards = new Set()
          data.forEach((user) => {
            Object.keys(user.board_comments).forEach((board) =>
              allBoards.add(board)
            )
          })
          const sortedBoards = Array.from(allBoards).sort()
          const headers = [
            "使用者",
            "本文留言數",
            ...sortedBoards,
            "生涯總留言數",
          ]

          let table = `${title}\n`
          table += headers.join("\t") + "\n"
          table += data
            .map((user) =>
              [
                user.user,
                user.article_comments,
                ...sortedBoards.map((board) => user.board_comments[board] || 0),
                user.total_comments,
              ].join("\t")
            )
            .join("\n")
          return table
        }

        if (result.highlighted_data.length > 0) {
          text +=
            generateTableText(result.highlighted_data, "--- 高亮使用者 ---") +
            "\n\n"
        }
        if (result.normal_data.length > 0) {
          text += generateTableText(result.normal_data, "--- 一般使用者 ---")
        }
        return text
      }
    </script>
  </body>
</html>
