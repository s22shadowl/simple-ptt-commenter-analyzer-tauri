<!DOCTYPE html>
<html lang="zh-TW" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PTT 留言分析器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* 基本樣式 */
      body {
        font-family: "Inter", "Noto Sans TC", sans-serif;
      }
      /* Tooltip 樣式 */
      .tooltip {
        position: relative;
        display: inline-block;
      }
      .tooltip .tooltip-text {
        visibility: hidden;
        width: 320px;
        background-color: #2d3748;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        bottom: 150%;
        left: 50%;
        margin-left: -160px;
        opacity: 0;
        transition: opacity 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        pointer-events: none;
      }
      .tooltip .tooltip-text {
        bottom: auto;
        top: 150%;
      }
      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
      /* 設定 Modal 的樣式 */
      #settings-modal {
        transition: opacity 0.3s ease;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-300 pb-20">
    <main class="container mx-auto p-4 md:p-8 max-w-4xl">
      <!-- 標題 -->
      <header class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-white">PTT 留言分析器</h1>
        <div class="flex items-center space-x-2">
          <!-- 設定圖示 -->
          <button id="settings-btn" class="text-gray-400 hover:text-white">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="3"></circle>
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
              ></path>
            </svg>
          </button>
          <!-- 說明圖示 -->
          <div class="tooltip">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="text-gray-400 hover:text-white cursor-pointer"
            >
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <div class="tooltip-text tracking-wide leading-relaxed">
              <h3 class="font-bold text-lg mb-4 text-green-400">使用說明</h3>
              <div class="space-y-4 text-sm">
                <!-- Section 1: Highlight Condition -->
                <div>
                  <strong class="font-semibold text-base text-gray-200"
                    >高亮條件</strong
                  >
                  <p class="mt-1 text-gray-400">
                    根據使用者在特定看板的留言數或佔比來標示。
                  </p>
                  <div class="mt-2 space-y-1">
                    <p class="text-xs text-gray-500">格式:</p>
                    <code
                      class="block w-full text-left p-2 bg-gray-900 text-green-400 rounded-md text-xs font-mono"
                      >看板名稱,比較符,數字(%)</code
                    >
                    <p class="text-xs text-gray-500 mt-2">範例:</p>
                    <code
                      class="inline-block px-1.5 py-0.5 bg-gray-900 text-green-400 rounded-md text-xs font-mono"
                      >Gossiping,&gt;,10%</code
                    >
                    <code
                      class="inline-block px-1.5 py-0.5 bg-gray-900 text-green-400 rounded-md text-xs font-mono"
                      >Stock,&lt;=,5</code
                    >
                  </div>
                </div>
                <!-- Section 2: Keywords -->
                <div>
                  <strong class="font-semibold text-base text-gray-200"
                    >留言關鍵字</strong
                  >
                  <p class="mt-1 text-gray-400">
                    篩選留言內容包含特定字詞的使用者 (OR 邏輯)。可用<code
                      class="text-green-400 font-mono"
                      >,</code
                    >分隔多個關鍵字。
                  </p>
                </div>
                <!-- Section 3: Comment Types -->
                <div>
                  <strong class="font-semibold text-base text-gray-200"
                    >留言類型</strong
                  >
                  <p class="mt-1 text-gray-400">
                    可複選「推」、「噓」或「→」，篩選特定類型的留言。
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- 輸入表單 -->
      <form id="analysis-form" class="space-y-6">
        <!-- 第一排: 文章網址 -->
        <div>
          <label for="url" class="block mb-2 text-lg font-medium text-white"
            >文章網址</label
          >
          <input
            type="url"
            id="url"
            class="w-full bg-gray-800 border border-gray-600 text-white text-base rounded-lg focus:ring-green-500 focus:border-green-500 block p-3"
            placeholder="https://www.ptt.cc/bbs/..."
            required
          />
        </div>

        <!-- 第二排: 高亮條件 -->
        <div>
          <label
            for="highlight"
            class="block mb-2 text-base font-medium text-white"
            >高亮條件 (選填)</label
          >
          <input
            type="text"
            id="highlight"
            class="w-full bg-gray-800 border border-gray-600 text-white text-base rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5"
            placeholder="看板名稱,比較符,數字(%)"
          />
        </div>

        <!-- 第三排: 關鍵字、類型、按鈕 -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 items-end">
          <!-- 留言關鍵字 -->
          <div class="sm:col-span-1">
            <label
              for="keywords"
              class="block mb-2 text-base font-medium text-white"
              >留言關鍵字 (選填)</label
            >
            <input
              type="text"
              id="keywords"
              class="w-full bg-gray-800 border border-gray-600 text-white text-base rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5"
              placeholder="台灣,中國 (以 , 分隔)"
            />
          </div>

          <!-- 留言類型 -->
          <div class="sm:col-span-1">
            <label class="block mb-2 text-base font-medium text-white"
              >留言類型</label
            >
            <div
              class="flex items-center space-x-4 bg-gray-800 border border-gray-600 rounded-lg p-2.5"
            >
              <div class="flex items-center">
                <input
                  id="type-push"
                  type="checkbox"
                  value="push"
                  class="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-600 ring-offset-gray-800 focus:ring-2"
                  checked
                />
                <label
                  for="type-push"
                  class="ml-2 text-sm font-medium text-gray-300"
                  >推</label
                >
              </div>
              <div class="flex items-center">
                <input
                  id="type-hate"
                  type="checkbox"
                  value="hate"
                  class="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-600 ring-offset-gray-800 focus:ring-2"
                  checked
                />
                <label
                  for="type-hate"
                  class="ml-2 text-sm font-medium text-gray-300"
                  >噓</label
                >
              </div>
              <div class="flex items-center">
                <input
                  id="type-arrow"
                  type="checkbox"
                  value="arrow"
                  class="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-600 ring-offset-gray-800 focus:ring-2"
                  checked
                />
                <label
                  for="type-arrow"
                  class="ml-2 text-sm font-medium text-gray-300"
                  >→</label
                >
              </div>
            </div>
          </div>

          <!-- 開始分析按鈕 -->
          <div class="sm:col-span-1">
            <button
              type="submit"
              id="submit-btn"
              class="w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-800 font-medium rounded-lg text-base px-5 py-2.5 text-center transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed flex items-center justify-center"
            >
              <span id="btn-text">開始分析</span>
              <svg
                id="btn-loader"
                class="hidden animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </form>

      <!-- 進度回報區 -->
      <div id="progress-container" class="hidden mt-6">
        <div class="flex justify-between mb-1">
          <span
            id="progress-text"
            class="text-base font-medium text-white"
          ></span>
          <span id="progress-percentage" class="text-sm font-medium text-white"
            >0%</span
          >
        </div>
        <div class="w-full bg-gray-700 rounded-full h-2.5">
          <div
            id="progress-bar"
            class="bg-green-600 h-2.5 rounded-full"
            style="width: 0%"
          ></div>
        </div>
      </div>

      <!-- 錯誤訊息區 -->
      <div
        id="error-container"
        class="hidden mt-6 p-4 text-sm text-red-400 bg-red-900/20 rounded-lg"
        role="alert"
      ></div>

      <!-- 報告元數據顯示區 -->
      <div
        id="metadata-container"
        class="hidden mt-8 p-4 bg-gray-800 border border-gray-700 rounded-lg space-y-2"
      ></div>

      <!-- 結果展示區 -->
      <div id="result-container" class="hidden mt-4">
        <div class="flex justify-end mb-4">
          <button
            id="copy-btn"
            class="text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:outline-none focus:ring-gray-700 font-medium rounded-lg text-sm px-4 py-2 transition-colors flex items-center"
          >
            <svg
              class="w-4 h-4 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
              ></path>
            </svg>
            <span id="copy-btn-text">複製報告</span>
          </button>
        </div>
        <div
          id="result-tables"
          class="max-h-[60vh] overflow-y-auto rounded-lg border border-gray-700"
        >
          <!-- 表格會動態插入此處 -->
        </div>
      </div>
    </main>

    <!-- (新增) Footer -->
    <footer
      class="fixed bottom-0 left-0 right-0 text-center py-4 bg-gray-900 border-t border-gray-800"
    >
      <a
        href="https://github.com/s22shadowl/simple-ptt-commenter-analyzer-tauri"
        target="_blank"
        rel="noopener noreferrer"
        class="text-sm text-gray-500 hover:text-gray-400 transition-colors"
      >
        <!-- 在此填寫製作人聲明 -->
        v1.0.0 by s22shadowl
      </a>
    </footer>

    <!-- 設定 Modal -->
    <div
      id="settings-modal"
      class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden opacity-0"
    >
      <div
        class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md border border-gray-700"
      >
        <h2 class="text-2xl font-bold text-white mb-4">爬蟲設定</h2>
        <form id="settings-form">
          <div class="space-y-4">
            <div>
              <label
                for="settings-boards"
                class="block mb-2 text-base font-medium text-white"
                >查詢看板 (以 , 分隔)</label
              >
              <textarea
                id="settings-boards"
                rows="3"
                class="w-full bg-gray-700 border border-gray-600 text-white text-base rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5"
              ></textarea>
            </div>
            <div>
              <label class="block mb-2 text-base font-medium text-white"
                >排序方式</label
              >
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="settings-sort-by" class="text-sm text-gray-400"
                    >排序欄位</label
                  >
                  <select
                    id="settings-sort-by"
                    class="w-full mt-1 bg-gray-700 border border-gray-600 text-black text-base rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5"
                  >
                    <option>本文留言數</option>
                    <option>生涯總留言數</option>
                  </select>
                </div>
                <div>
                  <label for="settings-order" class="text-sm text-gray-400"
                    >排序順序</label
                  >
                  <select
                    id="settings-order"
                    class="w-full mt-1 bg-gray-700 border border-gray-600 text-black text-base rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5"
                  >
                    <option value="desc">由多到少 (desc)</option>
                    <option value="asc">由少到多 (asc)</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-6 flex justify-end space-x-3">
            <button
              type="button"
              id="settings-cancel-btn"
              class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-600 rounded-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 focus:ring-offset-gray-900"
            >
              取消
            </button>
            <button
              type="submit"
              class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 focus:ring-offset-gray-900"
            >
              儲存
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { core, event } from "@tauri-apps/api"
      import { writeText } from "@tauri-apps/plugin-clipboard-manager"
      import { openUrl } from "@tauri-apps/plugin-opener"

      const { invoke } = core
      const { listen } = event

      // DOM Elements
      const form = document.getElementById("analysis-form")
      const submitBtn = document.getElementById("submit-btn")
      const btnText = document.getElementById("btn-text")
      const btnLoader = document.getElementById("btn-loader")
      const progressContainer = document.getElementById("progress-container")
      const progressText = document.getElementById("progress-text")
      const progressBar = document.getElementById("progress-bar")
      const progressPercentage = document.getElementById("progress-percentage")
      const errorContainer = document.getElementById("error-container")
      const metadataContainer = document.getElementById("metadata-container")
      const resultContainer = document.getElementById("result-container")
      const resultTables = document.getElementById("result-tables")
      const copyBtn = document.getElementById("copy-btn")
      const copyBtnText = document.getElementById("copy-btn-text")

      // 設定 Modal 的 DOM Elements
      const settingsBtn = document.getElementById("settings-btn")
      const settingsModal = document.getElementById("settings-modal")
      const settingsForm = document.getElementById("settings-form")
      const settingsCancelBtn = document.getElementById("settings-cancel-btn")
      const settingsBoards = document.getElementById("settings-boards")
      const settingsSortBy = document.getElementById("settings-sort-by")
      const settingsOrder = document.getElementById("settings-order")

      // App state
      let analysisResultCache = null
      // AppConfig 狀態，使用 Rust 的 Default 值作為初始值
      let appConfig = {
        boards: ["Gossiping", "HatePolitics"],
        sorting: {
          sortBy: "本文留言數",
          order: "desc",
        },
      }

      // Event Listeners
      listen("SCRAPE_PROGRESS", (event) => {
        const { current, total, user_id } = event.payload
        const percentage = Math.round((current / total) * 100)
        progressText.textContent = `[${current}/${total}] 正在查詢 ${user_id}...`
        progressBar.style.width = `${percentage}%`
        progressPercentage.textContent = `${percentage}%`
      })

      document.querySelector("footer a").addEventListener("click", (e) => {
        e.preventDefault()
        openUrl(e.currentTarget.href)
      })

      form.addEventListener("submit", async (e) => {
        e.preventDefault()
        setLoadingState(true)
        resetUI()

        const url = document.getElementById("url").value
        const keywords = document
          .getElementById("keywords")
          .value.split(",")
          .map((k) => k.trim())
          .filter((k) => k)
        const highlightCondition = document.getElementById("highlight").value

        const filterTypes = []
        document
          .querySelectorAll('input[type="checkbox"]:checked')
          .forEach((checkbox) => {
            filterTypes.push(checkbox.value)
          })

        // 建立 payload，並包含 config
        const payload = {
          url,
          filterTypes,
          keywords: keywords.length > 0 ? keywords : null,
          highlightCondition: highlightCondition || null,
          config: appConfig, // 將當前的設定一起傳給後端
        }

        try {
          const result = await invoke("analyze_ptt_article", {
            payload: payload,
          })
          analysisResultCache = result
          renderResult(result)
        } catch (error) {
          showError(error)
        } finally {
          setLoadingState(false)
        }
      })

      copyBtn.addEventListener("click", async () => {
        if (!analysisResultCache) return

        const reportText = generateReportText(analysisResultCache)
        try {
          await writeText(reportText)
          copyBtnText.textContent = "已複製 ✓"
          setTimeout(() => {
            copyBtnText.textContent = "複製報告"
          }, 2000)
        } catch (err) {
          console.error("無法複製到剪貼簿:", err)
          copyBtnText.textContent = "複製失敗"
        }
      })

      // 設定 Modal 的事件監聽
      settingsBtn.addEventListener("click", () => {
        // 開啟 Modal 前，將目前的設定值填入表單
        settingsBoards.value = appConfig.boards.join(", ")
        settingsSortBy.value = appConfig.sorting.sortBy
        settingsOrder.value = appConfig.sorting.order

        settingsModal.classList.remove("hidden")
        setTimeout(() => settingsModal.classList.remove("opacity-0"), 10) // 觸發淡入效果
      })

      settingsCancelBtn.addEventListener("click", () => {
        settingsModal.classList.add("opacity-0")
        setTimeout(() => settingsModal.classList.add("hidden"), 300) // 等待動畫結束後隱藏
      })

      settingsForm.addEventListener("submit", (e) => {
        e.preventDefault()

        // 儲存設定
        appConfig.boards = settingsBoards.value
          .split(",")
          .map((b) => b.trim())
          .filter((b) => b)
        appConfig.sorting.sortBy = settingsSortBy.value
        appConfig.sorting.order = settingsOrder.value

        console.log("設定已更新:", appConfig)

        // 關閉 Modal
        settingsModal.classList.add("opacity-0")
        setTimeout(() => settingsModal.classList.add("hidden"), 300)
      })

      // UI Functions
      function setLoadingState(isLoading) {
        submitBtn.disabled = isLoading
        btnText.classList.toggle("hidden", isLoading)
        btnLoader.classList.toggle("hidden", !isLoading)
      }

      function resetUI() {
        errorContainer.classList.add("hidden")
        metadataContainer.classList.add("hidden")
        resultContainer.classList.add("hidden")
        progressContainer.classList.remove("hidden")
        progressBar.style.width = "0%"
        progressText.textContent = "準備開始分析..."
        progressPercentage.textContent = "0%"
        metadataContainer.innerHTML = ""
        resultTables.innerHTML = ""
        analysisResultCache = null
      }

      function renderResult(result) {
        progressContainer.classList.add("hidden")

        renderMetadata(result.metadata)
        metadataContainer.classList.remove("hidden")

        resultContainer.classList.remove("hidden")
        resultTables.innerHTML = ""

        if (
          result.highlightedData?.length === 0 &&
          result.normalData?.length === 0
        ) {
          resultTables.innerHTML = `<p class="p-4 text-center text-gray-400">找不到符合條件的使用者留言。</p>`
          return
        }

        if (result.highlightedData?.length > 0) {
          resultTables.appendChild(
            createTable(result.highlightedData, "高亮使用者")
          )
        }
        if (result.normalData?.length > 0) {
          resultTables.appendChild(createTable(result.normalData, "一般使用者"))
        }
      }

      function renderMetadata(metadata) {
        const keywordsText = metadata.keywords
          ? metadata.keywords.join(", ")
          : "(無)"
        const highlightText = metadata.highlightCondition || "(無)"

        metadataContainer.innerHTML = `
                <p><strong class="font-medium text-gray-400">文章標題:</strong> <span class="text-white">${
                  metadata.title
                }</span></p>
                <p><strong class="font-medium text-gray-400">看板:</strong> <span class="text-white">${
                  metadata.board
                }</span></p>
                <p><strong class="font-medium text-gray-400">篩選類型:</strong> <span class="text-white">${
                  metadata.filterTypes.join(", ") || "(無)"
                }</span></p>
                <p><strong class="font-medium text-gray-400">關鍵字:</strong> <span class="text-white">${keywordsText}</span></p>
                <p><strong class="font-medium text-gray-400">高亮條件:</strong> <span class="text-white">${highlightText}</span></p>
               `
      }

      function createTable(data, title) {
        const allBoards = new Set()
        data.forEach((user) => {
          Object.keys(user.board_comments).forEach((board) =>
            allBoards.add(board)
          )
        })
        const sortedBoards = Array.from(allBoards).sort()
        const headers = [
          "使用者",
          "本文留言數",
          ...sortedBoards,
          "生涯總留言數",
        ]

        const container = document.createElement("div")
        container.innerHTML = `
              <h3 class="text-xl font-semibold p-4 bg-gray-800 text-white sticky top-0 z-10">${title}</h3>
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-400">
                  <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                    <tr>
                      ${headers
                        .map(
                          (h) => `<th scope="col" class="px-6 py-3">${h}</th>`
                        )
                        .join("")}
                    </tr>
                  </thead>
                  <tbody>
                    ${data
                      .map(
                        (user) => `
                    <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-600">
                      <td class="px-6 py-4 font-medium text-white whitespace-nowrap">${
                        user.user
                      }</td>
                      <td class="px-6 py-4">${user.article_comments}</td>
                      ${sortedBoards
                        .map(
                          (board) =>
                            `<td class="px-6 py-4">${
                              user.board_comments[board] || 0
                            }</td>`
                        )
                        .join("")}
                      <td class="px-6 py-4">${user.total_comments}</td>
                    </tr>
                  `
                      )
                      .join("")}
                  </tbody>
                </table>
              </div>
            `
        return container
      }

      function showError(error) {
        progressContainer.classList.add("hidden")
        errorContainer.textContent = `發生錯誤: ${error}`
        errorContainer.classList.remove("hidden")
      }

      function generateReportText(result) {
        const { metadata, highlightedData, normalData } = result
        let text = `--- 報告資訊 ---\n`
        text += `文章標題: ${metadata.title}\n`
        text += `看板: ${metadata.board}\n`
        text += `文章網址: ${metadata.url}\n`
        text += `篩選類型: ${metadata.filterTypes.join(", ") || "(無)"}\n`
        text += `關鍵字: ${
          metadata.keywords ? metadata.keywords.join(", ") : "(無)"
        }\n`
        text += `高亮條件: ${metadata.highlightCondition || "(無)"}\n\n`

        const generateTableText = (data, title) => {
          if (!data || data.length === 0) return ""
          const allBoards = new Set()
          data.forEach((user) => {
            Object.keys(user.board_comments).forEach((board) =>
              allBoards.add(board)
            )
          })
          const sortedBoards = Array.from(allBoards).sort()
          const headers = [
            "使用者",
            "本文留言數",
            ...sortedBoards,
            "生涯總留言數",
          ]

          let table = `${title}\n`
          table += headers.join("\t") + "\n"
          table += data
            .map((user) =>
              [
                user.user,
                user.article_comments,
                ...sortedBoards.map((board) => user.board_comments[board] || 0),
                user.total_comments,
              ].join("\t")
            )
            .join("\n")
          return table
        }

        if (highlightedData?.length > 0) {
          text +=
            generateTableText(highlightedData, "--- 高亮使用者 ---") + "\n\n"
        }
        if (normalData?.length > 0) {
          text += generateTableText(normalData, "--- 一般使用者 ---")
        }
        return text
      }
    </script>
  </body>
</html>
